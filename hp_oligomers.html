<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <script type='text/javascript' src='https://code.jquery.com/jquery-2.1.0.min.js'></script>
    
    <style type="text/css" media="screen" class="example">
        div.tooltip-donut {
            position: absolute;
            text-align: center;
            padding: .5rem;
            background: #FFFFFF;
            color: #313639;
            border: 1px solid #313639;
            border-radius: 8px;
            pointer-events: none;
            font-size: 1.3rem;
        }

        path.line {
            fill: none;
            opacity: 0.5;
            stroke: grey;
            stroke-width: 1px;
            vector-effect: non-scaling-stroke;
        }

        circle.dot {
            height: 25px;
            width: 25px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;

        }

        #draggable {
            border: 1px solid black;
            position: absolute;
            display: inline-block;
            top: 0;
            left: 0;
        }
    </style>
    <title>Hp Oligomers</title>
</head>

<body>
    <div style="position: absolute; top: 600px;">
        <button id="resetBtn">Reset zoom</button>
        <button id='addMaximasButton'>Add maximas</button>
        <button id='reconstructSpectrumButton'>Reconstruct Spectrum</button>
        <button id='removeChainsButton'>Hide reconstruction</button>
    </div>
    <svg id="chart" style="left: 100px; top: 40px; position: absolute;"></svg>
    <div style="position: absolute; top: 650px;">
<br>- press "Reconstruct spectrum" to plot Hp proteoforms generated in silico over the native MS mass profile</br>
    <br>- use mouse to pan and zoom</br>
    <br>- press "Add maximas" to plot maximas detected in the native MS mass profile</br>
<br>- point to the bar to see its mass and the glycan composition</br>
<br>- click any proteofrom and point cursor to any other proteoform to see the relative difference in mass and glycan composition</br>
</div>
    <script>

        var margin = {
            top: 20,
            right: 75,
            bottom: 20,
            left: 75
        }, width = 1500 - margin.left - margin.right,
            height = 550 - margin.top - margin.bottom,
            radius = 3, barwidth = 2, threshold = 0.5;


        var svg = d3.select("#chart")
        svg.attr("height", height);
        svg.attr("width", width);


        svg.append('defs')
            .append('clipPath')
            .attr('id', 'clip')
            .append('rect')
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', width)
            .attr('height', height);

        const main = svg.append('g')
            .attr('class', 'main')
            .attr('clip-path', 'url(#clip)');

        var xScale = d3.scale.linear().clamp(true)
            .domain([0, 20000])
            //.domain([0, d3.max(barData, function (d) { return d.x; })])
            .range([margin.left, width - margin.right])
            .nice();

        var yScale = d3.scale.linear()
            .domain([0, 100])
            .range([height - margin.top, margin.bottom])
            .nice();

        var xAxis = d3.svg.axis().scale(xScale).tickSize(1).tickSubdivide(true).orient("bottom");
        var yAxis = d3.svg.axis().scale(yScale).tickSize(1).tickSubdivide(true).tickFormat(d3.format("")).orient('left');

        var dataset = [{
            x: 0, y: 0, h: 0,
            hn: 0,
            f: 0,
            diff: [0],
            hdif: [0],
            hndif: [0],
            fdif: [0]
        }];

        var annotations = [];

        var minZoom = 1;
        var maxZoom = 100;
        var zoom = d3.behavior.zoom();

        svg.append('svg:g')
            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + (height - margin.bottom) + ')')
            .call(xAxis)
            .append("text")
            .attr("y", margin.bottom + 20)
            .attr("x", width / 2)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Mass (Da)");

        svg.append('svg:g').attr('class', 'y axis').attr('transform', 'translate(' + margin.left + ',0)')
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", -48)
            .attr("x", margin.top - height / 2)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Rel.ab. (%)");


        var gBar = main.append('svg:g').attr("id", "peaks");
        //var svg = main.append('svg:g').attr("id", "dots");

        var colorScale = d3.scale.category10();

        var div = d3.select("body").append("div")
            .attr("class", "tooltip-donut")
            .style("opacity", 0);

        var files = {
            "Dimer-Hp11((\u03B11)2(\u03B2)2)": { file: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/11_2_nat.json", file2: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/11_2_sim.json", file3: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/11_2.csv" },
            "Trimer-Hp21((\u03B11)2(\u03B12)(\u03B2)3)": { file: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_3_nat.json", file2: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_3_sim.json", file3: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_3.csv" },
            "Tetramer-Hp21((\u03B11)2(\u03B12)2(\u03B2)4)": { file: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_4_nat.json", file2: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_4_sim.json", file3: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_4.csv" },
            "Pentamer-Hp21((\u03B11)2(\u03B12)3(\u03B2)5)": { file: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_5_nat.json", file2: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_5_sim.json", file3: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_5.csv" },
            "Hexamer-Hp21((\u03B11)2(\u03B12)4(\u03B2)6)": { file: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_6_sim.json", file2: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/21_6_sim.json", file3: "" },
            "Trimer-Hp22((\u03B12)3(\u03B2)3)": { file: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/22_3_sim.json", file2: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/22_3_sim.json", file3: "" },
            "Tetramer-Hp22((\u03B12)4(\u03B2)4)": { file: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/22_4_sim.json", file2: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/22_4_sim.json", file3: "" },
            "Pentamer-Hp22((\u03B12)5(\u03B2)5)": { file: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/22_5_sim.json", file2: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/22_5_sim.json", file3: "" },
            "Hexamer-Hp22((\u03B12)6(\u03B2)6)": { file: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/22_6_sim.json", file2: "https://raw.githubusercontent.com/stamara6/Haptoglobin/master/22_6_sim.json", file3: "" }
        };

        var keys = Object.keys(files);

        var selector = d3.select("body")
            .append("select")
            .attr("id", "spectrumselector")
            .selectAll("option")
            .data(keys)
            .enter().append("option")
            .text(function (k) { return k; })
            .attr("value", function (k, i) {
                return i;
            });

        var k = keys[0];

        var legend = main.append('g')
            .attr('class', 'legend')
            .attr("transform", "translate(50,30)")
            .attr("data-style-padding", 10)
            .style("font-size", "16px");


        function isAboveThreshold(d) {
            return d.relab > threshold;
        }

        d3.select("#spectrumselector").property("selectedIndex", keys.indexOf(k));

        d3.select("#spectrumselector")
            .on("change", function (d) {

                idx = this.value;

                d3.json(files[keys[idx]].file, function (error, data) {
                    if (error) throw error;
                    if (files[keys[idx]].file3 != "") {
                        d3.csv(files[keys[idx]].file3).get(function (error, rows) {

                            updateData(data, rows, files[keys[idx]].file2);

                        });
                    } else { updateData(data, "", files[keys[idx]].file2); }

                });
            });

        d3.json(files[k].file, function (error, data) {
            if (error) throw error;

            var subdata = data.filter(isAboveThreshold);

            d3.csv(files[k].file3).get(function (error, rows) {

                updateData(subdata, rows, files[k].file2);

            });

        });

        function updateData(data, rows, file2) {

            gBar.selectAll('rect').remove();
            main.selectAll('path.line').remove();
            legend.selectAll('rect').remove();
            legend.selectAll('text').remove();

            data.filter(function (d) { return d.relab > threshold })
                .map(function (d) {
                    d.y = parseFloat(d.relab);
                    d.x = parseFloat(d.x);
                });

            var maxY = d3.max(data, function (d) {
                return d.relab;
            });

            var xMin = d3.min(data, function (d) { return d.x; }) - 100;
            var xMax = d3.max(data, function (d) { return d.x; }) + 100;

            var xScale = d3.scale.linear().clamp(true)
                .domain([d3.min(data, function (d) { return d.x; }) - 100, d3.max(data, function (d) { return d.x; }) + 100])
                .range([margin.left, width - margin.right])
                .nice();

            var yScale = d3.scale.linear()
                .domain([0, d3.max(data, function (d) { return d.relab })])
                .range([height - margin.top, margin.bottom])
                .nice();

            yScale.domain();
            xScale.domain();

            yAxis.scale(yScale);
            xAxis.scale(xScale);

            d3.select(".y")
                .transition()
                .duration(300)
                .call(yAxis);

            d3.select(".x")
                .transition()
                .duration(300)
                .call(xAxis);


            var line = d3.svg.line()
                .x(function (d) { return xScale(d.x); })
                .y(function (d) { return yScale(d.relab); })
                .interpolate("cardinal");

            main.append("svg:path")
                .attr("class", "line")
                .attr("fill", "none")
                .attr("d", function (d) { return line(rows); })

            var zoom = d3.behavior.zoom()
                .scaleExtent([minZoom, maxZoom])
                .x(xScale)
                .scaleExtent([1, 20])
                .on("zoom", zoomed);

            function zoomed() {

                var t = zoom.translate(),
                    scale = zoom.scale();

                //console.log(t);
                //console.log(scale);

                svg.select(".x.axis").call(xAxis);

                let newx = xScale.domain();
                //console.log(newx);

                //svg.select(".y.axis").call(yAxis);

                var w = 3;
                if (scale > 2 && scale < 4) {
                    w = 5;
                }
                if (scale > 5 && scale < 7) {
                    w = 7;
                }
                if (scale > 7) {
                    w = 10;
                }

                //d3.select("#zoomValue").text(" " + d3.round(zoom.scale(), 2));
                /*
                                d3.selectAll("rect")
                                    .attr("width", w / scale)
                                    .attr("transform", "translate(" + t[0] + ",0)scale(" + scale + ", 1)");
                
                */
                d3.selectAll("#peaks>rect")
                    //.filter("d", function (d) { return d.x > newx[0] && d.x < newx[1] })
                    .attr('x', function (d) {
                        return xScale(d.x) - (w / 2);
                    })
                    .attr("width", w);

                circleAttrs = {
                    cx: function (d) {
                        //console.log("cx" + d.x);
                        return xScale(d.x);
                    },
                    cy: function (d) { return yScale(d.y); },
                    r: radius
                };


                svg.selectAll("circle.dot")
                    //.filter("d", function (d) { return d.x > newx[0] && d.x < newx[1] })
                    .attr(circleAttrs);

                // main.attr("transform","translate("+ t[0]+",0)scale("+scale+"0)");

                main.selectAll("path.line")
                    //.filter("d", function (d) { return d.x > newx[0] && d.x < newx[1] })
                    .attr("d", function (d) {
                        return line(rows)
                    });
                //.attr("transform", "translate(" + t[0] + ",0)scale(" + scale + ", 1)");
            }

            function resetZoom() {
                // alert("de");
                //updateData(data, i, keys);
                zoom.scale(1);
                zoom.translate([0, 0]);
                svg.transition().duration(500).attr('transform', 'translate(' + zoom.translate() + ') scale(' + zoom.scale() + ')')
                zoomed();
            }

            svg.call(zoom)
                .on("dblclick.zoom", function () {
                    resetZoom();
                });


            colorScale.domain(data.map(function (d) { return d.FragmentType; }));

            d3.select("#resetBtn").on("click", resetZoom);
            d3.select("#removeBtn").on("click", remove);
            d3.select("#removeDotsBtn").on("click", removeDots);
            d3.select("#removeLabelsBtn").on("click", removeLabels);
            //d3.select("#removeLstDotBtn").on("click", removeLstDot);
            //d3.select("#saveAnnotationButton").on("click", saveAnnotation);
            //d3.select("#exportAnnotationsButton").on("click", exportAnnotations);
            //d3.select("#exportSpectrumButton").on("click", exportSpectrum);
            d3.select("#addMaximasButton").on("click", addMaximas);
            d3.select("#reconstructSpectrumButton").on("click", reconstructSpectrum);
            d3.select("#removeChainsButton").on("click", removeChains);

            d3.select(".x").transition().call(xAxis);

            function remove() {

                gBar.selectAll('rect').remove();
                gBar.selectAll('text').remove();
                svg.selectAll('circle').remove();
                //svg.selectAll('text').remove();

            }

            function removeDots() {

                svg.selectAll('circle').remove();
                svg.selectAll('text.lab1').remove();
                dataset = [{
                    x: 0, y: 0, h: 0,
                    hn: 0,
                    f: 0, diff: [0],
                    hdif: [0],
                    hndif: [0],
                    fdif: [0]
                }];
                //svg.selectAll('text').remove();

            }

            function removeLabels() {

                svg.selectAll('text.lab1').remove();
                //svg.selectAll('text').remove();

            }

            function removeLstDot() {

                dataset.pop();
                //svg.selectAll('text').remove();

            }

            function removeChains() {

                gBar.selectAll("rect.bar1").remove();
                gBar.selectAll("rect.bar2").remove();
                legend.selectAll('rect').remove();
                legend.selectAll('text').remove();
                svg.selectAll('text.lab1').remove();
                svg.selectAll('circle').remove();
                dataset = [{
                    x: 0, y: 0, h: 0,
                    hn: 0,
                    f: 0, diff: [0],
                    hdif: [0],
                    hndif: [0],
                    fdif: [0]
                }];
            }

            function saveAnnotation() {

                annotations.push(dataset);
                console.log(annotations[annotations.length - 1]);

                svg.selectAll('circle').remove();
                svg.selectAll('text').remove();
                dataset = [{
                    x: 0, y: 0, h: 0,
                    hn: 0,
                    f: 0, diff: [0],
                    hdif: [0],
                    hndif: [0],
                    fdif: [0]
                }];

                //svg.selectAll('text').remove();
            }

            function exportAnnotations() {

                //annotations.push(dataset);

                //console.log(annotations[annotations.length - 1]);               

                var csv = convertToCsv2(annotations);

                downloadContent({
                    type: 'text/csv;charset=utf-8',
                    filename: 'data.csv',
                    content: csv
                });

                svg.selectAll('circle').remove();
                svg.selectAll('text').remove();
                dataset = [{
                    x: 0, y: 0, h: 0,
                    hn: 0,
                    f: 0, diff: [0],
                    hdif: [0],
                    hndif: [0],
                    fdif: [0]
                }];

                //svg.selectAll('text').remove();

            }

            function exportSpectrum() {

                var csv = convertToCsv3(data);

                downloadContent({
                    type: 'text/csv;charset=utf-8',
                    filename: 'spectrum' + '.csv',
                    content: csv
                });
                //svg.selectAll('text').remove();

            }

            function convertToCsv(data) {
                var csvArray = ['Mz,Rel.ab.,Diff'];
                data.forEach(function (d) {
                    //if (d[0] != "0" && d[1] != "0")
                    csvArray.push(d.x + ',' + d.y + ',' + d.diff[0])
                });
                return csvArray.join("\n");
            }

            function convertToCsv2(data) {

                var csvArray = ['no.,Mz,Rel.ab.,Diff'];
                for (var i = 0; i < data.length; i++) {
                    data[i].forEach(function (d) {
                        //if (d[0] != "0" && d[1] != "0")
                        csvArray.push(i + ',' + d.x + ',' + d.y + ',' + d.diff[0])
                    });

                }

                return csvArray.join("\n");
            }

            function convertToCsv3(data) {

                var csvArray = ['Mz,Int,Rel.ab.'];
                data.forEach(function (d) {
                    csvArray.push(d.Mz + ',' + d.Intensity + ',' + d.relab)
                });

                return csvArray.join("\n");
            }


            function convertToCsv4(data, m) {

                var csvArray = ['Precursor,Mz,Int,Rel.ab.'];
                data.forEach(function (d) {
                    csvArray.push(d.Mz + ',' + d.Intensity + ',' + d.relab)
                });

                return csvArray.join("\n");
            }


            function downloadContent(options) {
                if (!options || !options.content) {
                    throw 'You have at least to provide content to download';
                }
                options.filename = options.filename || 'tolle.txt';
                options.type = options.type || 'text/plain;charset=utf-8';
                options.bom = options.bom || decodeURIComponent('%ef%bb%bf');

                if (window.navigator.msSaveBlob) {
                    var blob = new Blob([options.bom + options.content],
                        { type: options.type });
                    window.navigator.msSaveBlob(blob, options.filename);
                }
                else {
                    var link = document.createElement('a');
                    var content = options.bom + options.content;
                    var uriScheme = ['data:', options.type, ','].join('');
                    link.href = uriScheme + content;
                    link.download = options.filename;
                    //FF requires the link in actual DOM
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            function addMaximas() {

                gBar.selectAll('bar1')
                    .data(data).enter()
                    .append('rect')
                    .filter(function (d) { return d.relab > threshold })
                    .attr('x', function (d) {
                        return xScale(d.x) - (barwidth / 2);
                    })
                    .attr('y', function (d) {
                        p = yScale(d.relab);
                        return p;
                    })
                    .attr("class", "bar1")
                    .attr('width', barwidth)
                    .attr('height', function (d) {
                        return yScale(0) - yScale(d.relab);
                    })
                    .attr('fill', function (d) {
                        return "grey";
                    })
                    .attr('opacity', function (d) {
                        if (d.FragmentType != "" && d.Tagged)
                            return 1;
                        else
                            return 0.4;
                    })
                    .on('click', function (d, i) {
                        d3.select(this).transition()
                            .duration('50')
                            .attr('opacity', '.85');
                        div.transition()
                            .duration(50)
                            .style("opacity", 1);
                        let peak = d3.round(d.Mz - dataset[dataset.length - 1].x, 2); //+ "\n" + d.FragmentType + "_" + d.Letter + d.Position;
                        div.html(peak)
                            .style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY - 15) + "px");
                    })
                    .on('mouseover', function (d, i) {
                        d3.select(this).transition()
                            .duration('50')
                            .attr('fill', "red")
                            .attr('opacity', '.85');
                        div.transition()
                            .duration(50)
                            .style("opacity", 1);
                        let peak = d3.round(d.x - dataset[dataset.length - 1].x, 2); //+ "\n" + d.FragmentType + "_" + d.Letter + d.Position;
                        div.html(peak)
                            .style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY - 15) + "px");
                    })
                    .on('mouseout', function (d, i) {
                        d3.select(this).transition()
                            .duration('50')
                            .attr('opacity', function (d) {
                                return 0.5;
                            })
                            .attr('fill', "grey");
                        div.transition()
                            .duration('50')
                            .style("opacity", 0);
                    })
                    .on("click", function (d) {

                        var coords = d3.mouse(this);

                        console.log(coords);

                        console.log(d);

                        var newData = {
                            x: d.x,  // Takes the pixel number to convert to number
                            y: d.relab,
                            h: d.hex,
                            hn: d.hexnac,
                            f: d.hexnac,
                            diff: [],
                            hdif: [],
                            hndif: [],
                            fdif: []
                        };

                        console.log(newData);

                        dataset.push(newData);

                        getMassDifferences(dataset);

                        svg.selectAll("circle")  // For new circle, go through the update process
                            .data(dataset)
                            .enter()
                            .append("circle")
                            .attr("class", "dot")
                            .attr(circleAttrs)  // Get attributes from circleAttrs var
                            .on("mouseover", handleMouseOver)
                            .on("mouseout", handleMouseOut);

                    });



                gBar.selectAll('text')
                    .data(data).enter()
                    .append('text')
                    .filter(function (d) { return d.relab > threshold })
                    .attr("class", "pikMass")
                    .attr('x', function (d) {
                        var xPos = xScale(d.x);
                        return xPos;
                    })
                    .attr('y', function (d) {
                        p = yScale(d.relab);
                        return p;
                    })
                    .on('mouseover', function (d, i) {
                        d3.select(this).transition()
                            .duration('50')
                            .attr('opacity', '.85');
                        div.transition()
                            .duration(50)
                            .style("opacity", 1);
                        let peak = d3.round(d.x, 2); //+ "\n" + d.FragmentType + "_" + d.Letter + d.Position;
                        div.html(peak)
                            .style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY - 15) + "px");
                    })
                    .on('mouseout', function (d, i) {
                        d3.select(this).transition()
                            .duration('50')
                            .attr('opacity', '1');
                        div.transition()
                            .duration('50')
                            .style("opacity", 0);
                    })
                    .text(function (d, e) {
                        if (d.FragmentType != "") {
                            if (dataset.length == 0) {
                                dataset.push({ x: 0, y: 0, dif: 0 });
                            }
                            //  console.log("e "+ d.x, e);
                            var label = d3.round(d.x - dataset[dataset.length - 1].x, 2); //FragmentType + "_" + d.Letter + d.Position;
                            var label;
                            return;
                        }
                        else
                            return "";
                    });

            }

            function reconstructSpectrum() {

                d3.json(file2, function (error, data2) {

                    var subdata2 = data2.filter(isAboveThreshold);

                    subdata2.filter(function (d) { return d.relab > threshold }).map(function (d) {
                        d.y = parseFloat(d.relab);
                        d.x = parseFloat(d.x);
                    });

                    var maxY = d3.max(subdata2, function (d) {
                        return d.relab;
                    });

                    //console.log(data2[j]);
                    gBar.selectAll('bar2')
                        .data(subdata2).enter()
                        .append('rect')
                        .attr('x', function (d) {
                            return xScale(d.x) - (barwidth / 2);
                        })
                        .attr('y', function (d) {
                            p = yScale(d.relab);
                            return p;
                        })
                        .attr("class", "bar2")
                        .attr('width', barwidth)
                        .attr('height', function (d) {
                            return yScale(0) - yScale(d.relab);
                        })
                        .attr('fill', function (d) {
                            return colorScale(d.fuc);
                        })
                        .attr('opacity', function (d) {
                            return 0.5;
                        })
                        .on('mouseover', function (d, i) {
                            let sugardiff = "H" + (d.hex - dataset[dataset.length - 1].h) + "HN" + (d.hexnac - dataset[dataset.length - 1].hn) + "F" + (d.fuc - dataset[dataset.length - 1].f);
                            d3.select(this).transition()
                                .duration('50')
                                .attr('opacity', 1);
                            div.transition()
                                .duration(50)
                                .style("opacity", 1);
                            let peak = d3.round(d.x - dataset[dataset.length - 1].x, 2) + " | " + sugardiff; //+ "\n" + d.FragmentType + "_" + d.Letter + d.Position;
                            div.html(peak)
                                .style("left", (d3.event.pageX + 10) + "px")
                                .style("top", (d3.event.pageY - 15) + "px");
                        })
                        .on('mouseout', function (d, i) {
                            d3.select(this).transition()
                                .duration('50')
                                .attr('opacity', function (d) {
                                    return 0.5;
                                });
                            div.transition()
                                .duration('50')
                                .style("opacity", 0);
                        })
                        .on("click", function (d) {

                            var coords = d3.mouse(this);

                            console.log(coords);

                            console.log(d);

                            var newData = {
                                x: d.x,  // Takes the pixel number to convert to number
                                y: d.relab,
                                h: d.hex,
                                hn: d.hexnac,
                                f: d.fuc,
                                diff: [],
                                hdif: [],
                                hndif: [],
                                fdif: []
                            };

                            console.log(newData);

                            //dataset.pop();
                            dataset.push(newData);

                            getMassDifferences(dataset);

                            svg.selectAll("circle")  // For new circle, go through the update process
                                .data(dataset)
                                .enter()
                                .append("circle")
                                .filter(function (d) { return d.y > threshold })
                                .attr("class", "dot")
                                .attr(circleAttrs)  // Get attributes from circleAttrs var
                                .on("mouseover", handleMouseOver)
                                .on("mouseout", handleMouseOut);

                            svg.selectAll("text")
                                .data(dataset)
                                .enter()
                                .append("text")
                                .attr('class', "lab1")
                                .attr({
                                    //id: "t" + d.x + "-" + d.y + "-" + i,  // Create an id for text so we can select it later for removing on mouseout
                                    x: function () { return xScale(d.x) - 30; },
                                    y: function () { return yScale(d.y) - 15; }
                                })
                                .text(function () {
                                    var label = Math.round(d.diff[0], 2) + "|" + "H" + d.hdif + "HN" + d.hndif + "F" + d.fdif;
                                    return label;  // Value of the text
                                });
                        });


                    legend.selectAll('text')
                        .data(d3.map(subdata2, function (d) { return d.fuc; }).keys())
                        .enter()
                        .append('text')
                        .text(function (d) {
                            return d;
                        })
                        .attr('x', width - margin.left)
                        .attr('y', function (d, j) {
                            return (j + 2) * 18;
                        })
                        .attr('text-anchor', 'start')
                        .attr('alignment-baseline', 'hanging');

                    legend.selectAll('rect')
                        .data(d3.map(subdata2, function (d) { return d.fuc; }).keys())
                        .enter()
                        .append('rect')
                        .attr('x', width - margin.left - 18)
                        .attr('y', function (d, i) {
                            return (i + 2) * 18;
                        })
                        .attr('width', 12)
                        .attr('height', 12)
                        .attr('fill', function (d, i) {
                            return colorScale(d);
                        })
                        .attr('alignment-baseline', 'hanging');

                    legend.append('text')
                        .text(function () {
                            return "Fuc";
                        })
                        .attr('x', width - margin.left - 18)
                        .attr('y', function () {
                            return 18;
                        })
                        .attr('text-anchor', 'start')
                        .attr('alignment-baseline', 'hanging');


                });
            }

            var circleAttrs = {
                cx: function (d) { return xScale(d.x); },
                cy: function (d) { return yScale(d.y); },
                r: radius
            };

            svg.selectAll("circle")
                .attr(circleAttrs);

            function getMassDifferences(d) {

                if (d.length == 1) {
                    return;
                } else if (d.length == 2) {
                    d[0].diff.push(d[1].x - d[0].x);
                    d[0].hdif.push(d[1].h - d[0].h);
                    d[0].hndif.push(d[1].hn - d[0].hn);
                    d[0].fdif.push(d[1].f - d[0].f);
                }

                i = d.length - 1;
                m0 = d[i].x;
                h0 = d[i].h;
                hn0 = d[i].hn;
                f0 = d[i].f;

                for (var j = d.length - 2; j >= 0 && j > d.length - 4; j--) {

                    m1 = d[j].x;
                    h1 = d[j].h;
                    hn1 = d[j].hn;
                    f1 = d[j].f;

                    dif = m0 - m1;
                    dif_h = h0 - h1;
                    dif_hn = hn0 - hn1;
                    dif_f = f0 - f1;

                    d[i].diff.push(dif);
                    d[i].hdif.push(dif_h);
                    d[i].hndif.push(dif_hn);
                    d[i].fdif.push(dif_f);
                }

                return d;

            }

            // Create Event Handlers for mouse
            function handleMouseOver(d, i) {  // Add interactivity
                // Use D3 to select element, change color and size
                d3.select(this).attr({
                    fill: "orange",
                    r: radius * 2
                });

                // Specify where to put label of text
                svg.append("text")
                    .attr('class', "lab1")
                    .attr({
                        id: "t" + d.x + "-" + d.y + "-" + i,  // Create an id for text so we can select it later for removing on mouseout
                        x: function () { return xScale(d.x) - 30; },
                        y: function () { return yScale(d.y) - 15; }
                    })
                    .text(function () {
                        var label = Math.round(d.diff[0], 2) + "|" + "H" + d.hdif[0] + "HN" + d.hndif[0] + "F" + d.fdif[0];
                        return label;  // Value of the text
                    });
            }

            function handleMouseOut(d, i) {
                // Use D3 to select element, change color back to normal
                d3.select(this).attr({
                    fill: "black",
                    r: radius
                });

                // Select text by id and then remove
                d3.select("#t" + d.x + "-" + d.y + "-" + i).remove();  // Remove text location
            }

            // Set-up the export button
            d3.select('#saveButton').on('click', function () {
                var svgString = getSVGString(svg.node());
                svgString2Image(svgString, 2 * width, 2 * height, 'png', save); // passes Blob and filesize String to the callback

                function save(dataBlob, filesize) {
                    saveAs(dataBlob, 'D3toPng.png'); // FileSaver.js function
                }
            });

            // Set-up the export button
            d3.select('#saveSvgButton').on('click', function () {

                //get svg source.
                var serializer = new XMLSerializer();
                var svgString = serializer.serializeToString(svg.node());

                //add name spaces.
                if (!svgString.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                    svgString = svgString.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                if (!svgString.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
                    svgString = svgString.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }

                //add xml declaration
                svgString = '<?xml version="1.0" standalone="no"?>\r\n' + svgString;

                var blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });

                //var filesize = Math.round(blob.length / 1024) + ' KB';

                saveAs(blob, 'D3toSvg.svg')

            });

            // Below are the functions that handle actual exporting:
            // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
            function getSVGString(svgNode) {
                svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
                var cssStyleText = getCSSStyles(svgNode);
                appendCSS(cssStyleText, svgNode);

                var serializer = new XMLSerializer();
                var svgString = serializer.serializeToString(svgNode);
                svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
                svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

                return svgString;

                function getCSSStyles(parentElement) {
                    var selectorTextArr = [];

                    // Add Parent element Id and Classes to the list
                    selectorTextArr.push('#' + parentElement.id);
                    for (var c = 0; c < parentElement.classList.length; c++)
                        if (!contains('.' + parentElement.classList[c], selectorTextArr))
                            selectorTextArr.push('.' + parentElement.classList[c]);

                    // Add Children element Ids and Classes to the list
                    var nodes = parentElement.getElementsByTagName("*");
                    for (var i = 0; i < nodes.length; i++) {
                        var id = nodes[i].id;
                        if (!contains('#' + id, selectorTextArr))
                            selectorTextArr.push('#' + id);

                        var classes = nodes[i].classList;
                        for (var c = 0; c < classes.length; c++)
                            if (!contains('.' + classes[c], selectorTextArr))
                                selectorTextArr.push('.' + classes[c]);
                    }

                    // Extract CSS Rules
                    var extractedCSSText = "";
                    for (var i = 0; i < document.styleSheets.length; i++) {
                        var s = document.styleSheets[i];

                        try {
                            if (!s.cssRules) continue;
                        } catch (e) {
                            if (e.name !== 'SecurityError') throw e; // for Firefox
                            continue;
                        }

                        var cssRules = s.cssRules;
                        for (var r = 0; r < cssRules.length; r++) {
                            if (contains(cssRules[r].selectorText, selectorTextArr))
                                extractedCSSText += cssRules[r].cssText;
                        }
                    }


                    return extractedCSSText;

                    function contains(str, arr) {
                        return arr.indexOf(str) === -1 ? false : true;
                    }

                }

                function appendCSS(cssText, element) {
                    var styleElement = document.createElement("style");
                    styleElement.setAttribute("type", "text/css");
                    styleElement.innerHTML = cssText;
                    var refNode = element.hasChildNodes() ? element.children[0] : null;
                    element.insertBefore(styleElement, refNode);
                }
            }


            function svgString2Image(svgString, width, height, format, callback) {
                var format = format ? format : 'png';

                var imgsrc = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString))); // Convert SVG string to data URL

                var canvas = document.createElement("canvas");
                var context = canvas.getContext("2d");

                canvas.width = width;
                canvas.height = height;

                var image = new Image();
                image.onload = function () {
                    context.clearRect(0, 0, width, height);
                    context.drawImage(image, 0, 0, width, height);

                    canvas.toBlob(function (blob) {
                        var filesize = Math.round(blob.length / 1024) + ' KB';
                        if (callback) callback(blob, filesize);
                    });


                };

                image.src = imgsrc;
            }



        }


    </script>
</body>

</html>
